(function(){var e,n,c,g,I,s,p,h,a,P,u,o,d,i,S,r,B,t,l,f,m,C,y,b,x,v,w,mt,D,R,yt,bt,tt,et,it,M=[].indexOf||function(t){for(var e=0,i=this.length;e<i;e++)if(e in this&&this[e]===t)return e;return-1},L=[].slice,F={}.hasOwnProperty,k=function(t,e){return function(){return t.apply(e,arguments)}};v=["extended","included"],r=function(){function t(){}return t.extends=function(t){var e,i,r;for(e in t)r=t[e],M.call(v,e)<0&&(this[e]=r);return null!=(i=t.extended)&&i.apply(this),this},t.includes=function(t){var e,i,r;for(e in t)r=t[e],M.call(v,e)<0&&(this.prototype[e]=r);return null!=(i=t.included)&&i.apply(this),this},t.delegate=function(){var t,e,i,r,n,s;for(s=(t=1<=arguments.length?L.call(arguments,0):[]).pop(),r=[],i=0,e=t.length;i<e;i++)n=t[i],r.push(this.prototype[n]=s.prototype[n]);return r},t.aliasFunction=function(t,e){return this.prototype[t]=(i=this,function(){var t;return t=1<=arguments.length?L.call(arguments,0):[],i.prototype[e].apply(i,t)});var i},t.aliasProperty=function(t,e){return Object.defineProperty(this.prototype,t,{get:function(){return this[e]},set:function(t){return this[e]=t}})},t.included=function(t){return t.call(this,this.prototype)},t}(),Array.prototype.slice,e=function(t,e){return null==e&&(e=document),"object"==typeof t||"undefined"!=typeof exports&&null!==exports?t:e.querySelector(t)},C=function(){function t(){}var e;return t.uniqid=(e=0,{get:function(){return e++}}),t.extend=function(){var t,e,i,r,n,s;for(e=arguments[0],r=0,i=(s=2<=arguments.length?L.call(arguments,1):[]).length;r<i;r++)for(n in t=s[r])F.call(t,n)&&(e[n]=t[n]);return e},t.clampRGB=function(t){return t<0?0:255<t?255:t},t.copyAttributes=function(t,e,i){var r,n,s,o,a,h;for(null==i&&(i={}),h=[],s=0,n=(o=t.attributes).length;s<n;s++)r=o[s],null!=i.except&&(a=r.nodeName,0<=M.call(i.except,a))||h.push(e.setAttribute(r.nodeName,r.nodeValue));return h},t.dataArray=function(t){return null==t&&(t=0),I.NodeJS||null!=window.Uint8Array?new Uint8Array(t):new Array(t)},t}(),"undefined"!=typeof exports&&null!==exports?(f=exports,p=require("canvas"),d=p.Image,P=require("fibers"),y=require("fs"),b=require("http"),x=require("https")):f=window,I=function(t){function w(){var t,e,i,r;if(this.nodeFileReady=k(this.nodeFileReady,this),0===arguments.length)throw"Invalid arguments";return this instanceof w?(this.finishInit=this.finishInit.bind(this),this.imageLoaded=this.imageLoaded.bind(this),t=arguments[0],w.NodeJS||(i=parseInt(w.getAttrId(t[0]),10),e="function"==typeof t[1]?t[1]:"function"==typeof t[2]?t[2]:function(){},isNaN(i)||!m.has(i))?(this.id=C.uniqid.get(),this.initializedPixelData=this.originalPixelData=null,this.cropCoordinates={x:0,y:0},this.cropped=!1,this.resized=!1,this.pixelStack=[],this.layerStack=[],this.canvasQueue=[],this.currentLayer=null,this.scaled=!1,this.analyze=new n(this),this.renderer=new l(this),this.domIsLoaded((r=this,function(){return r.parseArguments(t),r.setup()})),this):m.execute(i,e)):new w(arguments)}return function(t,e){for(var i in e)F.call(e,i)&&(t[i]=e[i]);function r(){this.constructor=t}r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype}(w,r),w.version={release:"4.1.2",date:"7/27/2013"},w.DEBUG=!1,w.allowRevert=!0,w.crossOrigin="anonymous",w.remoteProxy="",w.proxyParam="camanProxyUrl",w.NodeJS="undefined"!=typeof exports&&null!==exports,w.autoload=!w.NodeJS,w.toString=function(){return"Version "+w.version.release+", Released "+w.version.date},w.getAttrId=function(t){return!!w.NodeJS||("string"==typeof t&&(t=e(t)),null==t||null==t.getAttribute?null:t.getAttribute("data-caman-id"))},w.prototype.domIsLoaded=function(t){var e,i,r,n;return w.NodeJS?setTimeout((n=this,function(){return t.call(n)}),0):"complete"===document.readyState?(S.debug("DOM initialized"),setTimeout((r=this,function(){return t.call(r)}),0)):(i=this,e=function(){if("complete"===document.readyState)return S.debug("DOM initialized"),t.call(i)},document.addEventListener("readystatechange",e,!1))},w.prototype.parseArguments=function(t){var e,i,r,n;if(0===t.length)throw"Invalid arguments given";if(this.initObj=null,this.initType=null,this.imageUrl=null,this.callback=function(){},this.setInitObject(t[0]),1!==t.length){switch(typeof t[1]){case"string":this.imageUrl=t[1];break;case"function":this.callback=t[1]}if(2!==t.length&&(this.callback=t[2],4===t.length)){for(e in r=[],i=t[4])F.call(i,e)&&(n=i[e],r.push(this.options[e]=n));return r}}},w.prototype.setInitObject=function(t){if(w.NodeJS)return this.initObj=t,void(this.initType="node");if(this.initObj="object"==typeof t?t:e(t),null==this.initObj)throw"Could not find image or canvas for initialization.";return this.initType=this.initObj.nodeName.toLowerCase()},w.prototype.setup=function(){switch(this.initType){case"node":return this.initNode();case"img":return this.initImage();case"canvas":return this.initCanvas()}},w.prototype.initNode=function(){return S.debug("Initializing for NodeJS"),"string"==typeof this.initObj&&this.initObj.match(/^https?:\/\//)?this.readFromHttp(this.initObj,this.nodeFileReady):"string"==typeof this.initObj?y.readFile(this.initObj,this.nodeFileReady):this.nodeFileReady(null,this.initObj)},w.prototype.readFromHttp=function(t,i){return S.debug("Fetching image from "+t),this.client=t.match(/^https:\/\//)?x:b,this.client.get(t,function(t){var e;return e="",t.setEncoding("binary"),t.on("data",function(t){return e+=t}),t.on("end",function(){return i(null,new Buffer(e,"binary"))})}).on("error",i)},w.prototype.nodeFileReady=function(t,e){if(t)throw t;return this.image=new d,this.image.src=e,S.debug("Image loaded. Width = "+this.imageWidth()+", Height = "+this.imageHeight()),this.canvas=new p(this.imageWidth(),this.imageHeight()),this.finishInit()},w.prototype.initImage=function(){return this.image=this.initObj,this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),C.copyAttributes(this.image,this.canvas,{except:["src"]}),null!=this.image.parentNode&&this.image.parentNode.replaceChild(this.canvas,this.image),this.imageAdjustments(),this.waitForImageLoaded()},w.prototype.initCanvas=function(){return this.canvas=this.initObj,this.context=this.canvas.getContext("2d"),null!=this.imageUrl?(this.image=document.createElement("img"),this.image.src=this.imageUrl,this.imageAdjustments(),this.waitForImageLoaded()):this.finishInit()},w.prototype.imageAdjustments=function(){if(this.needsHiDPISwap()&&(S.debug(this.image.src,"->",this.hiDPIReplacement()),this.swapped=!0,this.image.src=this.hiDPIReplacement()),o.isRemote(this.image))return this.image.src=o.proxyUrl(this.image.src),S.debug("Remote image detected, using URL = "+this.image.src)},w.prototype.waitForImageLoaded=function(){return this.isImageLoaded()?this.imageLoaded():this.image.onload=this.imageLoaded},w.prototype.isImageLoaded=function(){return!!this.image.complete&&(null==this.image.naturalWidth||0!==this.image.naturalWidth)},w.prototype.imageWidth=function(){return this.image.width||this.image.naturalWidth},w.prototype.imageHeight=function(){return this.image.height||this.image.naturalHeight},w.prototype.imageLoaded=function(){return S.debug("Image loaded. Width = "+this.imageWidth()+", Height = "+this.imageHeight()),this.swapped?(this.canvas.width=this.imageWidth()/this.hiDPIRatio(),this.canvas.height=this.imageHeight()/this.hiDPIRatio()):(this.canvas.width=this.imageWidth(),this.canvas.height=this.imageHeight()),this.finishInit()},w.prototype.finishInit=function(){var t,e,i,r,n;if(null==this.context&&(this.context=this.canvas.getContext("2d")),this.originalWidth=this.preScaledWidth=this.width=this.canvas.width,this.originalHeight=this.preScaledHeight=this.height=this.canvas.height,this.hiDPIAdjustments(),this.hasId()||this.assignId(),null!=this.image&&this.context.drawImage(this.image,0,0,this.imageWidth(),this.imageHeight(),0,0,this.preScaledWidth,this.preScaledHeight),this.imageData=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),this.pixelData=this.imageData.data,w.allowRevert)for(this.initializedPixelData=C.dataArray(this.pixelData.length),this.originalPixelData=C.dataArray(this.pixelData.length),t=i=0,e=(n=this.pixelData).length;i<e;t=++i)r=n[t],this.initializedPixelData[t]=r,this.originalPixelData[t]=r;return this.dimensions={width:this.canvas.width,height:this.canvas.height},w.NodeJS||m.put(this.id,this),this.callback.call(this,this),this.callback=function(){}},w.prototype.reloadCanvasData=function(){return this.imageData=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),this.pixelData=this.imageData.data},w.prototype.resetOriginalPixelData=function(){var t,e,i,r,n,s;if(!w.allowRevert)throw"Revert disabled";for(this.originalPixelData=C.dataArray(this.pixelData.length),s=[],t=i=0,e=(n=this.pixelData).length;i<e;t=++i)r=n[t],s.push(this.originalPixelData[t]=r);return s},w.prototype.hasId=function(){return null!=w.getAttrId(this.canvas)},w.prototype.assignId=function(){if(!w.NodeJS&&!this.canvas.getAttribute("data-caman-id"))return this.canvas.setAttribute("data-caman-id",this.id)},w.prototype.hiDPIDisabled=function(){return null!==this.canvas.getAttribute("data-caman-hidpi-disabled")},w.prototype.hiDPIAdjustments=function(){var t;if(!w.NodeJS&&this.needsHiDPISwap())return 1!==(t=this.hiDPIRatio())?(S.debug("HiDPI ratio = "+t),this.scaled=!0,this.preScaledWidth=this.canvas.width,this.preScaledHeight=this.canvas.height,this.canvas.width=this.preScaledWidth*t,this.canvas.height=this.preScaledHeight*t,this.canvas.style.width=this.preScaledWidth+"px",this.canvas.style.height=this.preScaledHeight+"px",this.context.scale(t,t),this.width=this.originalWidth=this.canvas.width,this.height=this.originalHeight=this.canvas.height):void 0},w.prototype.hiDPIRatio=function(){return(window.devicePixelRatio||1)/(this.context.webkitBackingStorePixelRatio||this.context.mozBackingStorePixelRatio||this.context.msBackingStorePixelRatio||this.context.oBackingStorePixelRatio||this.context.backingStorePixelRatio||1)},w.prototype.hiDPICapable=function(){return null!=window.devicePixelRatio&&1!==window.devicePixelRatio},w.prototype.needsHiDPISwap=function(){return!(this.hiDPIDisabled()||!this.hiDPICapable())&&null!==this.hiDPIReplacement()},w.prototype.hiDPIReplacement=function(){return null==this.image?null:this.image.getAttribute("data-caman-hidpi")},w.prototype.replaceCanvas=function(t){var e;return e=this.canvas,this.canvas=t,this.context=this.canvas.getContext("2d"),w.NodeJS||e.parentNode.replaceChild(this.canvas,e),this.width=this.canvas.width,this.height=this.canvas.height,this.reloadCanvasData(),this.dimensions={width:this.canvas.width,height:this.canvas.height}},w.prototype.render=function(t){return null==t&&(t=function(){}),a.trigger(this,"renderStart"),this.renderer.execute((e=this,function(){return e.context.putImageData(e.imageData,0,0),t.call(e)}));var e},w.prototype.revert=function(t){var e,i,r,n,s;if(null==t&&(t=!0),!w.allowRevert)throw"Revert disabled";for(e=r=0,i=(s=this.originalVisiblePixels()).length;r<i;e=++r)n=s[e],this.pixelData[e]=n;if(t)return this.context.putImageData(this.imageData,0,0)},w.prototype.reset=function(){var t,e,i,r,n,s,o,a,h;for(t=document.createElement("canvas"),C.copyAttributes(this.canvas,t),t.width=this.originalWidth,t.height=this.originalHeight,a=(r=(e=t.getContext("2d")).getImageData(0,0,t.width,t.height)).data,i=s=0,n=(h=this.initializedPixelData).length;s<n;i=++s)o=h[i],a[i]=o;return e.putImageData(r,0,0),this.cropCoordinates={x:0,y:0},this.resized=!1,this.replaceCanvas(t)},w.prototype.originalVisiblePixels=function(){var t,e,i,r,n,s,o,a,h,c,u,l,g,d,p,f,m,y,b,x,v;if(!w.allowRevert)throw"Revert disabled";if(l=[],r=(y=this.cropCoordinates.x)+this.width,n=(b=this.cropCoordinates.y)+this.height,this.resized){for((t=document.createElement("canvas")).width=this.originalWidth,t.height=this.originalHeight,u=(o=(i=t.getContext("2d")).getImageData(0,0,t.width,t.height)).data,s=h=0,a=(g=this.originalPixelData).length;h<a;s=++h)c=g[s],u[s]=c;i.putImageData(o,0,0),(m=document.createElement("canvas")).width=this.width,m.height=this.height,(i=m.getContext("2d")).drawImage(t,0,0,this.originalWidth,this.originalHeight,0,0,this.width,this.height),u=i.getImageData(0,0,this.width,this.height).data,v=this.width}else u=this.originalPixelData,v=this.originalWidth;for(s=x=0,d=u.length;x<d;s=x+=4)y<=(p=(e=B.locationToCoordinates(s,v)).x)&&p<r&&b<=(f=e.y)&&f<n&&l.push(u[s],u[s+1],u[s+2],u[s+3]);return l},w.prototype.process=function(t,e){return this.renderer.add({type:u.Type.Single,name:t,processFn:e}),this},w.prototype.processKernel=function(t,e,i,r){var n,s,o;if(null==i&&(i=null),null==r&&(r=0),null==i)for(n=s=i=0,o=e.length;0<=o?s<o:o<s;n=0<=o?++s:--s)i+=e[n];return this.renderer.add({type:u.Type.Kernel,name:t,adjust:e,divisor:i,bias:r}),this},w.prototype.processPlugin=function(t,e){return this.renderer.add({type:u.Type.Plugin,plugin:t,args:e}),this},w.prototype.newLayer=function(t){var e;return e=new i(this),this.canvasQueue.push(e),this.renderer.add({type:u.Type.LayerDequeue}),t.call(e),this.renderer.add({type:u.Type.LayerFinished}),this},w.prototype.executeLayer=function(t){return this.pushContext(t)},w.prototype.pushContext=function(t){return this.layerStack.push(this.currentLayer),this.pixelStack.push(this.pixelData),this.currentLayer=t,this.pixelData=t.pixelData},w.prototype.popContext=function(){return this.pixelData=this.pixelStack.pop(),this.currentLayer=this.layerStack.pop()},w.prototype.applyCurrentLayer=function(){return this.currentLayer.applyToParent()},w}(),(f.Caman=I).Analyze=function(){function t(t){this.c=t}return t.prototype.calculateLevels=function(){var t,e,i,r,n,s,o;for(e={r:{},g:{},b:{}},t=r=0;r<=255;t=++r)e.r[t]=0,e.g[t]=0,e.b[t]=0;for(t=s=0,n=this.c.pixelData.length;s<n;t=s+=4)e.r[this.c.pixelData[t]]++,e.g[this.c.pixelData[t+1]]++,e.b[this.c.pixelData[t+2]]++;for(i=this.c.pixelData.length/4,t=o=0;o<=255;t=++o)e.r[t]/=i,e.g[t]/=i,e.b[t]/=i;return e},t}(),n=I.Analyze,I.DOMUpdated=function(){var t,e,i,r,n;if(0<(e=document.querySelectorAll("img[data-caman]")).length){for(n=[],r=0,i=e.length;r<i;r++)t=e[r],n.push(new s(t,function(){return this.parse(),this.execute()}));return n}},I.autoload&&("complete"===document.readyState?I.DOMUpdated():document.addEventListener("DOMContentLoaded",I.DOMUpdated,!1)),s=function(){var l;function t(t,e){this.dataStr=t.getAttribute("data-caman"),this.caman=I(t,e.bind(this))}return l="(\\w+)\\((.*?)\\)",t.prototype.parse=function(){var t,e,i,r,n,s,o,a,h,c,u;if(this.ele=this.caman.canvas,a=new RegExp(l,"g"),0<(u=this.dataStr.match(a)).length){for(a=new RegExp(l),c=[],o=0,s=u.length;o<s;o++){(h=u[o].match(a))[0],i=h[1],t=h[2],n=new Function("return function() { this."+i+"("+t+"); };");try{r=n(),c.push(r.call(this.caman))}catch(t){e=t,c.push(S.debug(e))}}return c}},t.prototype.execute=function(){var t;return t=this.ele,this.caman.render(function(){return t.parentNode.replaceChild(this.toImage(),t)})},t}(),I.Blender=function(){function t(){}return t.blenders={},t.register=function(t,e){return this.blenders[t]=e},t.execute=function(t,e,i){return this.blenders[t](e,i)},t}(),c=I.Blender,I.Calculate=function(){function t(){}return t.distance=function(t,e,i,r){return Math.sqrt(Math.pow(i-t,2)+Math.pow(r-e,2))},t.randomRange=function(t,e,i){var r;return null==i&&(i=!1),r=t+Math.random()*(e-t),i?r.toFixed(i):Math.round(r)},t.luminance=function(t){return.299*t.r+.587*t.g+.114*t.b},t.bezier=function(t,e,i,r,n,s){var o,a,h,c,u,l,g,d,p,f,m,y,b;if(null==n&&(n=0),null==s&&(s=255),t[0]instanceof Array?(h=t,n=e,s=i):h=[t,e,i,r],h.length<2)throw"Invalid number of arguments to bezier";for(o={},g=function(t,e,i){return t*(1-i)+e*i},a=function(t,e,i){return Math.min(Math.max(t,e),i)},u=p=0;p<1e3;u=++p){for(y=u/1e3,f=h;1<f.length;){for(d=[],l=b=0,m=f.length-2;0<=m?b<=m:m<=b;l=0<=m?++b:--b)d.push([g(f[l][0],f[l+1][0],y),g(f[l][1],f[l+1][1],y)]);f=d}o[Math.round(f[0][0])]=Math.round(a(f[0][1],n,s))}return c=h[h.length-1][0],null==(o=I.Calculate.missingValues(o,c))[c]&&(o[c]=o[c-1]),o},t.hermite=function(t,e,i){var r,n,s,o,a,h,c,u,l,g,d,p,f,m,y,b,x,v,w,D,R,M,P,S;if(t.length<2)throw"Invalid number of arguments to hermite";for(R={},function(t,e,i){return t*(1-i)+e*i},r=function(t,e,i,r){return[t[0]+e[0]+i[0]+r[0],t[1]+e[1]+i[1]+r[1]]},p=function(t,e){return[t[0]*e[0],t[1]*e[1]]},M=function(t,e){return[t[0]-e[0],t[1]-e[1]]},n=function(t,e,i){return Math.min(Math.max(t,e),i)},u=f=0,w=t.length-2;0<=w?f<=w:w<=f;u=0<=w?++f:--f)for(m=t[u],x=1/(b=(y=t[u+1])[0]-m[0]),u===t.length-2&&(x=1/(b-1)),g=p(M(y,0<u?t[u-1]:m),[.5,.5]),d=p(M(u<t.length-2?t[u+2]:y,m),[.5,.5]),l=S=0,D=b;0<=D?S<=D:D<=S;l=0<=D?++S:--S)a=(P=l*x)*P*P-2*P*P+P,h=-2*P*P*P+3*P*P,c=P*P*P-P*P,v=r(p(m,[o=2*P*P*P-3*P*P+1,o]),p(g,[a,a]),p(y,[h,h]),p(d,[c,c])),R[Math.round(v[0])]=Math.round(n(v[1],e,i)),1;return s=t[t.length-1][0],R=I.Calculate.missingValues(R,s)},t.missingValues=function(t,e){var i,r,n,s,o,a,h,c,u,l;if(Object.keys(t).length<e+1){for(c={},i=s=0,o=e;0<=o?s<=o:o<=s;i=0<=o?++s:--s)if(null!=t[i])c[i]=t[i];else{for(n=[i-1,c[i-1]],r=l=a=i,h=e;a<=h?l<=h:h<=l;r=a<=h?++l:--l)if(null!=t[r]){u=[r,t[r]];break}c[i]=n[1]+(u[1]-n[1])/(u[0]-n[0])*(i-n[0])}return c}return t},t}(),g=I.Calculate,I.Convert=function(){function t(){}return t.hexToRGB=function(t){return"#"===t.charAt(0)&&(t=t.substr(1)),{r:parseInt(t.substr(0,2),16),g:parseInt(t.substr(2,2),16),b:parseInt(t.substr(4,2),16)}},t.rgbToHSL=function(t,e,i){var r,n,s,o,a,h;return"object"==typeof t&&(e=t.g,i=t.b,t=t.r),t/=255,e/=255,i/=255,o=Math.max(t,e,i),a=Math.min(t,e,i),s=(o+a)/2,o===a?n=h=0:(r=o-a,h=.5<s?r/(2-o-a):r/(o+a),n=function(){switch(o){case t:return(e-i)/r+(e<i?6:0);case e:return(i-t)/r+2;case i:return(t-e)/r+4}}(),n/=6),{h:n,s:h,l:s}},t.hslToRGB=function(t,e,i){var r,n,s,o,a;return"object"==typeof t&&(e=t.s,i=t.l,t=t.h),0===e?a=n=r=i:(s=2*i-(o=i<.5?i*(1+e):i+e-i*e),a=this.hueToRGB(s,o,t+1/3),n=this.hueToRGB(s,o,t),r=this.hueToRGB(s,o,t-1/3)),{r:255*a,g:255*n,b:255*r}},t.hueToRGB=function(t,e,i){return i<0&&(i+=1),1<i&&(i-=1),i<1/6?t+6*(e-t)*i:i<.5?e:i<2/3?t+(e-t)*(2/3-i)*6:t},t.rgbToHSV=function(t,e,i){var r,n,s,o,a,h;return t/=255,e/=255,i/=255,s=Math.max(t,e,i),o=Math.min(t,e,i),r=(h=s)-o,a=0===s?0:r/s,s===o?n=0:(n=function(){switch(s){case t:return(e-i)/r+(e<i?6:0);case e:return(i-t)/r+2;case i:return(t-e)/r+4}}(),n/=6),{h:n,s:a,v:h}},t.hsvToRGB=function(t,e,i){var r,n,s,o,a,h,c,u;switch(a=i*(1-e),h=i*(1-(n=6*t-(o=Math.floor(6*t)))*e),u=i*(1-(1-n)*e),o%6){case 0:c=i,s=u,r=a;break;case 1:c=h,s=i,r=a;break;case 2:c=a,s=i,r=u;break;case 3:c=a,s=h,r=i;break;case 4:c=u,s=a,r=i;break;case 5:c=i,s=a,r=h}return{r:Math.floor(255*c),g:Math.floor(255*s),b:Math.floor(255*r)}},t.rgbToXYZ=function(t,e,i){return e/=255,i/=255,.04045<(t/=255)?t=Math.pow((t+.055)/1.055,2.4):t/=12.92,.04045<e?e=Math.pow((e+.055)/1.055,2.4):e/=12.92,.04045<i?i=Math.pow((i+.055)/1.055,2.4):i/=12.92,{x:100*(.4124*t+.3576*e+.1805*i),y:100*(.2126*t+.7152*e+.0722*i),z:100*(.0193*t+.1192*e+.9505*i)}},t.xyzToRGB=function(t,e,i){var r,n,s;return n=-.9689*(t/=100)+1.8758*(e/=100)+.0415*(i/=100),r=.0557*t+-.204*e+1.057*i,.0031308<(s=3.2406*t+-1.5372*e+-.4986*i)?s=1.055*Math.pow(s,.4166666667)-.055:s*=12.92,.0031308<n?n=1.055*Math.pow(n,.4166666667)-.055:n*=12.92,.0031308<r?r=1.055*Math.pow(r,.4166666667)-.055:r*=12.92,{r:255*s,g:255*n,b:255*r}},t.xyzToLab=function(t,e,i){return"object"==typeof t&&(e=t.y,i=t.z,t=t.x),e/=100,i/=108.883,t=.008856451679<(t/=95.047)?Math.pow(t,.3333333333):7.787037037*t+.1379310345,{l:116*(e=.008856451679<e?Math.pow(e,.3333333333):7.787037037*e+.1379310345)-16,a:500*(t-e),b:200*(e-(i=.008856451679<i?Math.pow(i,.3333333333):7.787037037*i+.1379310345))}},t.labToXYZ=function(t,e,i){var r,n,s;return"object"==typeof t&&(e=t.a,i=t.b,t=t.l),s=(n=(t+16)/116)-i/200,.2068965517<(r=n+e/500)?r*=r*r:r=.1284185493*(r-.1379310345),.2068965517<n?n*=n*n:n=.1284185493*(n-.1379310345),.2068965517<s?s*=s*s:s=.1284185493*(s-.1379310345),{x:95.047*r,y:100*n,z:108.883*s}},t.rgbToLab=function(t,e,i){var r;return"object"==typeof t&&(e=t.g,i=t.b,t=t.r),r=this.rgbToXYZ(t,e,i),this.xyzToLab(r)},t.labToRGB=function(t,e,i){},t}(),h=I.Convert,I.Event=function(){function t(){}return t.events={},t.types=["processStart","processComplete","renderStart","renderFinished","blockStarted","blockFinished"],t.trigger=function(t,e,i){var r,n,s,o,a;if(null==i&&(i=null),this.events[e]&&this.events[e].length){for(a=[],s=0,n=(o=this.events[e]).length;s<n;s++)null===(r=o[s]).target||t.id===r.target.id?a.push(r.fn.call(t,i)):a.push(void 0);return a}},t.listen=function(t,e,i){var r,n;return"string"==typeof t&&(n=t,r=e,t=null,e=n,i=r),!(M.call(this.types,e)<0)&&(this.events[e]||(this.events[e]=[]),this.events[e].push({target:t,fn:i}),!0)},t}(),a=I.Event,I.Filter=function(){function t(){}return t.Type={Single:1,Kernel:2,LayerDequeue:3,LayerFinished:4,LoadOverlay:5,Plugin:6},t.register=function(t,e){return I.prototype[t]=e},t}(),u=I.Filter,I.IO=function(){function t(){}return t.domainRegex=/(?:(?:http|https):\/\/)((?:\w+)\.(?:(?:\w|\.)+))/,t.isRemote=function(t){return null!=t&&(!this.corsEnabled(t)&&this.isURLRemote(t.src))},t.corsEnabled=function(t){var e;return null!=t.crossOrigin&&("anonymous"===(e=t.crossOrigin.toLowerCase())||"use-credentials"===e)},t.isURLRemote=function(t){var e;return!!(e=t.match(this.domainRegex))&&e[1]!==document.domain},t.remoteCheck=function(t){if(this.isURLRemote(t)){if(I.remoteProxy.length)return I.isURLRemote(I.remoteProxy)?void S.info("Cannot use a remote proxy for loading images."):this.proxyUrl(t);S.info("Attempting to load a remote image without a configured proxy. URL: "+t)}},t.proxyUrl=function(t){return I.remoteProxy+"?"+I.proxyParam+"="+encodeURIComponent(t)},t.useProxy=function(t){var e;return null!=(e={ruby:"rb",python:"py",perl:"pl",javascript:"js"})[t=t.toLowerCase()]&&(t=e[t]),"proxies/caman_proxy."+t},t}(),I.prototype.save=function(){return"undefined"!=typeof exports&&null!==exports?this.nodeSave.apply(this,arguments):this.browserSave.apply(this,arguments)},I.prototype.browserSave=function(t){var e;return null==t&&(t="png"),t=t.toLowerCase(),e=this.toBase64(t).replace("image/"+t,"image/octet-stream"),document.location.href=e},I.prototype.nodeSave=function(e,t,i){null==t&&(t=!0),null==i&&(i=null);try{if(y.statSync(e).isFile()&&!t)return!1}catch(t){t,S.debug("Creating output file "+e)}return y.writeFile(e,this.canvas.toBuffer(),function(t){if(S.debug("Finished writing to "+e),i)return i.call(this,t)})},I.prototype.toImage=function(t){var e;return(e=new d).src=this.toBase64(t),e.width=this.dimensions.width,e.height=this.dimensions.height,window.devicePixelRatio&&(e.width/=window.devicePixelRatio,e.height/=window.devicePixelRatio),e},I.prototype.toBase64=function(t){return null==t&&(t="png"),t=t.toLowerCase(),this.canvas.toDataURL("image/"+t)},o=I.IO,I.Layer=function(){function t(t){this.c=t,this.filter=this.c,this.options={blendingMode:"normal",opacity:1},this.layerID=C.uniqid.get(),this.canvas="undefined"!=typeof exports&&null!==exports?new p:document.createElement("canvas"),this.canvas.width=this.c.dimensions.width,this.canvas.height=this.c.dimensions.height,this.context=this.canvas.getContext("2d"),this.context.createImageData(this.canvas.width,this.canvas.height),this.imageData=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),this.pixelData=this.imageData.data}return t.prototype.newLayer=function(t){return this.c.newLayer.call(this.c,t)},t.prototype.setBlendingMode=function(t){return this.options.blendingMode=t,this},t.prototype.opacity=function(t){return this.options.opacity=t/100,this},t.prototype.copyParent=function(){var t,e,i,r;for(i=this.c.pixelData,t=e=0,r=this.c.pixelData.length;e<r;t=e+=4)this.pixelData[t]=i[t],this.pixelData[t+1]=i[t+1],this.pixelData[t+2]=i[t+2],this.pixelData[t+3]=i[t+3];return this},t.prototype.fillColor=function(){return this.c.fillColor.apply(this.c,arguments)},t.prototype.overlayImage=function(t){return"object"==typeof t?t=t.src:"string"==typeof t&&"#"===t[0]&&(t=e(t).src),t&&this.c.renderer.renderQueue.push({type:u.Type.LoadOverlay,src:t,layer:this}),this},t.prototype.applyToParent=function(){var t,e,i,r,n,s,o,a,h;for(r=this.c.pixelStack[this.c.pixelStack.length-1],o=[],t=i=0,n=(e=this.c.pixelData).length;i<n;t=i+=4)h={r:r[t],g:r[t+1],b:r[t+2],a:r[t+3]},a={r:e[t],g:e[t+1],b:e[t+2],a:e[t+3]},(s=c.execute(this.options.blendingMode,a,h)).r=C.clampRGB(s.r),s.g=C.clampRGB(s.g),s.b=C.clampRGB(s.b),null==s.a&&(s.a=a.a),r[t]=h.r-(h.r-s.r)*(this.options.opacity*(s.a/255)),r[t+1]=h.g-(h.g-s.g)*(this.options.opacity*(s.a/255)),o.push(r[t+2]=h.b-(h.b-s.b)*(this.options.opacity*(s.a/255)));return o},t}(),i=I.Layer,I.Logger=function(){var t,e,i,r;for(i=0,t=(r=["log","info","warn","error"]).length;i<t;i++)this[e=r[i]]=function(i){return function(){var e;if(e=1<=arguments.length?L.call(arguments,0):[],I.DEBUG)try{return console[i].apply(console,e)}catch(t){return console[i](e)}}}(e);this.debug=this.log},S=new I.Logger,I.Pixel=function(){function r(t,e,i,r,n){this.r=null!=t?t:0,this.g=null!=e?e:0,this.b=null!=i?i:0,this.a=null!=r?r:255,this.c=null!=n?n:null,this.loc=0}return r.coordinatesToLocation=function(t,e,i){return 4*(e*i+t)},r.locationToCoordinates=function(t,e){return{x:t%(4*e)/4,y:Math.floor(t/(4*e))}},r.prototype.setContext=function(t){return this.c=t},r.prototype.locationXY=function(){var t;if(null==this.c)throw"Requires a CamanJS context";return t=this.c.dimensions.height-Math.floor(this.loc/(4*this.c.dimensions.width)),{x:this.loc%(4*this.c.dimensions.width)/4,y:t}},r.prototype.pixelAtLocation=function(t){if(null==this.c)throw"Requires a CamanJS context";return new r(this.c.pixelData[t],this.c.pixelData[t+1],this.c.pixelData[t+2],this.c.pixelData[t+3],this.c)},r.prototype.getPixelRelative=function(t,e){var i;if(null==this.c)throw"Requires a CamanJS context";return(i=this.loc+4*this.c.dimensions.width*(-1*e)+4*t)>this.c.pixelData.length||i<0?new r(0,0,0,255,this.c):this.pixelAtLocation(i)},r.prototype.putPixelRelative=function(t,e,i){if(null==this.c)throw"Requires a CamanJS context";if(this.loc+4*this.c.dimensions.width*(-1*e)+4*t,!(newLoc>this.c.pixelData.length||newLoc<0))return this.c.pixelData[newLoc]=i.r,this.c.pixelData[newLoc+1]=i.g,this.c.pixelData[newLoc+2]=i.b,this.c.pixelData[newLoc+3]=i.a,!0},r.prototype.getPixel=function(t,e){var i;if(null==this.c)throw"Requires a CamanJS context";return i=this.coordinatesToLocation(t,e,this.width),this.pixelAtLocation(i)},r.prototype.putPixel=function(t,e,i){var r;if(null==this.c)throw"Requires a CamanJS context";return r=this.coordinatesToLocation(t,e,this.width),this.c.pixelData[r]=i.r,this.c.pixelData[r+1]=i.g,this.c.pixelData[r+2]=i.b,this.c.pixelData[r+3]=i.a},r.prototype.toString=function(){return this.toKey()},r.prototype.toHex=function(t){var e;return null==t&&(t=!1),e="#"+this.r.toString(16)+this.g.toString(16)+this.b.toString(16),t?e+this.a.toString(16):e},r}(),B=I.Pixel,I.Plugin=function(){function t(){}return t.plugins={},t.register=function(t,e){return this.plugins[t]=e},t.execute=function(t,e,i){return this.plugins[e].apply(t,i)},t}(),t=I.Plugin,I.Renderer=function(){function l(t){this.c=t,this.processNext=k(this.processNext,this),this.renderQueue=[],this.modPixelData=null}return l.Blocks=I.NodeJS?require("os").cpus().length:4,l.prototype.add=function(t){if(null!=t)return this.renderQueue.push(t)},l.prototype.processNext=function(){var t;if(0===this.renderQueue.length)return a.trigger(this,"renderFinished"),null!=this.finishedFn&&this.finishedFn.call(this.c),this;switch(this.currentJob=this.renderQueue.shift(),this.currentJob.type){case u.Type.LayerDequeue:return t=this.c.canvasQueue.shift(),this.c.executeLayer(t),this.processNext();case u.Type.LayerFinished:return this.c.applyCurrentLayer(),this.c.popContext(),this.processNext();case u.Type.LoadOverlay:return this.loadOverlay(this.currentJob.layer,this.currentJob.src);case u.Type.Plugin:return this.executePlugin();default:return this.executeFilter()}},l.prototype.execute=function(t){return this.finishedFn=t,this.modPixelData=C.dataArray(this.c.pixelData.length),this.processNext()},l.prototype.eachBlock=function(n){var t,e,i,r,s,o,a,h,c,u;for(this.blocksDone=0,o=this.c.pixelData.length,s=(t=4*Math.floor(o/4/l.Blocks))+o/4%l.Blocks*4,c=[],r=a=0,h=l.Blocks;0<=h?a<h:h<a;r=0<=h?++a:--a)i=(u=r*t)+(r===l.Blocks-1?s:t),I.NodeJS?(e=P(function(t){return function(){return n.call(t,r,u,i)}}(this)).run(),c.push(this.blockFinished(e))):c.push(setTimeout(function(r){return function(t,e,i){return function(){return n.call(r,t,e,i)}}}(this)(r,u,i),0));return c},l.prototype.executeFilter=function(){return a.trigger(this.c,"processStart",this.currentJob),this.currentJob.type===u.Type.Single?this.eachBlock(this.renderBlock):this.eachBlock(this.renderKernel)},l.prototype.executePlugin=function(){return S.debug("Executing plugin "+this.currentJob.plugin),t.execute(this.c,this.currentJob.plugin,this.currentJob.args),S.debug("Plugin "+this.currentJob.plugin+" finished!"),this.processNext()},l.prototype.renderBlock=function(t,e,i){var r,n,s,o;for(S.debug("Block #"+t+" - Filter: "+this.currentJob.name+", Start: "+e+", End: "+i),a.trigger(this.c,"blockStarted",{blockNum:t,totalBlocks:l.Blocks,startPixel:e,endPixel:i}),(s=new B).setContext(this.c),r=n=e,o=i;n<o;r=n+=4)s.loc=r,s.r=this.c.pixelData[r],s.g=this.c.pixelData[r+1],s.b=this.c.pixelData[r+2],s.a=this.c.pixelData[r+3],this.currentJob.processFn(s),this.c.pixelData[r]=C.clampRGB(s.r),this.c.pixelData[r+1]=C.clampRGB(s.g),this.c.pixelData[r+2]=C.clampRGB(s.b),this.c.pixelData[r+3]=C.clampRGB(s.a);return I.NodeJS?P.yield(t):this.blockFinished(t)},l.prototype.renderKernel=function(t,e,i){var r,n,s,o,a,h,c,u,l,g,d,p,f,m,y,b,x,v,w,D,R,M;for(this.currentJob.name,s=this.currentJob.bias,h=this.currentJob.divisor,d=this.c.pixelData.length,r=this.currentJob.adjust,n=Math.sqrt(r.length),g=[],S.debug("Rendering kernel - Filter: "+this.currentJob.name),e=Math.max(e,4*this.c.dimensions.width*((n-1)/2)),i=Math.min(i,d-4*this.c.dimensions.width*((n-1)/2)),o=(n-1)/2,(m=new B).setContext(this.c),c=p=e,y=i;p<y;c=p+=4){for(m.loc=c,a=0,u=R=b=-o,x=o;b<=x?R<=x:x<=R;u=b<=x?++R:--R)for(l=M=v=o,w=-o;v<=w?M<=w:w<=M;l=v<=w?++M:--M)f=m.getPixelRelative(u,l),g[3*a]=f.r,g[3*a+1]=f.g,g[3*a+2]=f.b,a++;D=this.processKernel(r,g,h,s),this.modPixelData[c]=C.clampRGB(D.r),this.modPixelData[c+1]=C.clampRGB(D.g),this.modPixelData[c+2]=C.clampRGB(D.b),this.modPixelData[c+3]=this.c.pixelData[c+3]}return I.NodeJS?P.yield(t):this.blockFinished(t)},l.prototype.blockFinished=function(t){var e,i,r;if(0<=t&&S.debug("Block #"+t+" finished! Filter: "+this.currentJob.name),this.blocksDone++,a.trigger(this.c,"blockFinished",{blockNum:t,blocksFinished:this.blocksDone,totalBlocks:l.Blocks}),this.blocksDone===l.Blocks){if(this.currentJob.type===u.Type.Kernel)for(e=i=0,r=this.c.pixelData.length;0<=r?i<r:r<i;e=0<=r?++i:--i)this.c.pixelData[e]=this.modPixelData[e];return 0<=t&&S.debug("Filter "+this.currentJob.name+" finished!"),a.trigger(this.c,"processComplete",this.currentJob),this.processNext()}},l.prototype.processKernel=function(t,e,i,r){var n,s,o,a;for(a={r:0,g:0,b:0},n=s=0,o=t.length;0<=o?s<o:o<s;n=0<=o?++s:--s)a.r+=t[n]*e[3*n],a.g+=t[n]*e[3*n+1],a.b+=t[n]*e[3*n+2];return a.r=a.r/i+r,a.g=a.g/i+r,a.b=a.b/i+r,a},l.prototype.loadOverlay=function(t,e){var i,r,n;return(i=new d).onload=(n=this,function(){return t.context.drawImage(i,0,0,n.c.dimensions.width,n.c.dimensions.height),t.imageData=t.context.getImageData(0,0,n.c.dimensions.width,n.c.dimensions.height),t.pixelData=t.imageData.data,n.c.pixelData=t.pixelData,n.processNext()}),r=o.remoteCheck(e),i.src=null!=r?r:e},l}(),l=I.Renderer,I.Store=function(){function t(){}return t.items={},t.has=function(t){return null!=this.items[t]},t.get=function(t){return this.items[t]},t.put=function(t,e){return this.items[t]=e},t.execute=function(t,e){var i;return setTimeout((i=this,function(){return e.call(i.get(t),i.get(t))}),0),this.get(t)},t.flush=function(t){return null==t&&(t=!1),t?delete this.items[t]:this.items={}},t}(),m=I.Store,c.register("normal",function(t,e){return{r:t.r,g:t.g,b:t.b}}),c.register("multiply",function(t,e){return{r:t.r*e.r/255,g:t.g*e.g/255,b:t.b*e.b/255}}),c.register("screen",function(t,e){return{r:255-(255-t.r)*(255-e.r)/255,g:255-(255-t.g)*(255-e.g)/255,b:255-(255-t.b)*(255-e.b)/255}}),c.register("overlay",function(t,e){var i;return(i={}).r=128<e.r?255-2*(255-t.r)*(255-e.r)/255:e.r*t.r*2/255,i.g=128<e.g?255-2*(255-t.g)*(255-e.g)/255:e.g*t.g*2/255,i.b=128<e.b?255-2*(255-t.b)*(255-e.b)/255:e.b*t.b*2/255,i}),c.register("difference",function(t,e){return{r:t.r-e.r,g:t.g-e.g,b:t.b-e.b}}),c.register("addition",function(t,e){return{r:e.r+t.r,g:e.g+t.g,b:e.b+t.b}}),c.register("exclusion",function(t,e){return{r:128-2*(e.r-128)*(t.r-128)/255,g:128-2*(e.g-128)*(t.g-128)/255,b:128-2*(e.b-128)*(t.b-128)/255}}),c.register("softLight",function(t,e){var i;return(i={}).r=128<e.r?255-(255-e.r)*(255-(t.r-128))/255:e.r*(t.r+128)/255,i.g=128<e.g?255-(255-e.g)*(255-(t.g-128))/255:e.g*(t.g+128)/255,i.b=128<e.b?255-(255-e.b)*(255-(t.b-128))/255:e.b*(t.b+128)/255,i}),c.register("lighten",function(t,e){return{r:e.r>t.r?e.r:t.r,g:e.g>t.g?e.g:t.g,b:e.b>t.b?e.b:t.b}}),c.register("darken",function(t,e){return{r:e.r>t.r?t.r:e.r,g:e.g>t.g?t.g:e.g,b:e.b>t.b?t.b:e.b}}),u.register("fillColor",function(){var e;return e=1===arguments.length?h.hexToRGB(arguments[0]):{r:arguments[0],g:arguments[1],b:arguments[2]},this.process("fillColor",function(t){return t.r=e.r,t.g=e.g,t.b=e.b,t.a=255,t})}),u.register("brightness",function(e){return e=Math.floor(e/100*255),this.process("brightness",function(t){return t.r+=e,t.g+=e,t.b+=e,t})}),u.register("saturation",function(i){return i*=-.01,this.process("saturation",function(t){var e;return e=Math.max(t.r,t.g,t.b),t.r!==e&&(t.r+=(e-t.r)*i),t.g!==e&&(t.g+=(e-t.g)*i),t.b!==e&&(t.b+=(e-t.b)*i),t})}),u.register("vibrance",function(n){return n*=-1,this.process("vibrance",function(t){var e,i,r;return r=Math.max(t.r,t.g,t.b),i=(t.r+t.g+t.b)/3,e=2*Math.abs(r-i)/255*n/100,t.r!==r&&(t.r+=(r-t.r)*e),t.g!==r&&(t.g+=(r-t.g)*e),t.b!==r&&(t.b+=(r-t.b)*e),t})}),u.register("greyscale",function(t){return this.process("greyscale",function(t){var e;return e=g.luminance(t),t.r=e,t.g=e,t.b=e,t})}),u.register("contrast",function(e){return e=Math.pow((e+100)/100,2),this.process("contrast",function(t){return t.r/=255,t.r-=.5,t.r*=e,t.r+=.5,t.r*=255,t.g/=255,t.g-=.5,t.g*=e,t.g+=.5,t.g*=255,t.b/=255,t.b-=.5,t.b*=e,t.b+=.5,t.b*=255,t})}),u.register("hue",function(a){return this.process("hue",function(t){var e,i,r,n,s,o;return r=100*(n=h.rgbToHSV(t.r,t.g,t.b)).h,r+=Math.abs(a),r%=100,r/=100,n.h=r,s=(o=h.hsvToRGB(n.h,n.s,n.v)).r,i=o.g,e=o.b,t.r=s,t.g=i,t.b=e,t})}),u.register("colorize",function(){var e,i;return 2===arguments.length?(i=h.hexToRGB(arguments[0]),e=arguments[1]):4===arguments.length&&(i={r:arguments[0],g:arguments[1],b:arguments[2]},e=arguments[3]),this.process("colorize",function(t){return t.r-=(t.r-i.r)*(e/100),t.g-=(t.g-i.g)*(e/100),t.b-=(t.b-i.b)*(e/100),t})}),u.register("invert",function(){return this.process("invert",function(t){return t.r=255-t.r,t.g=255-t.g,t.b=255-t.b,t})}),u.register("sepia",function(e){return null==e&&(e=100),e/=100,this.process("sepia",function(t){return t.r=Math.min(255,t.r*(1-.607*e)+t.g*(.769*e)+t.b*(.189*e)),t.g=Math.min(255,t.r*(.349*e)+t.g*(1-.314*e)+t.b*(.168*e)),t.b=Math.min(255,t.r*(.272*e)+t.g*(.534*e)+t.b*(1-.869*e)),t})}),u.register("gamma",function(e){return this.process("gamma",function(t){return t.r=255*Math.pow(t.r/255,e),t.g=255*Math.pow(t.g/255,e),t.b=255*Math.pow(t.b/255,e),t})}),u.register("noise",function(i){return i=2.55*Math.abs(i),this.process("noise",function(t){var e;return e=g.randomRange(-1*i,i),t.r+=e,t.g+=e,t.b+=e,t})}),u.register("clip",function(e){return e=2.55*Math.abs(e),this.process("clip",function(t){return t.r>255-e?t.r=255:t.r<e&&(t.r=0),t.g>255-e?t.g=255:t.g<e&&(t.g=0),t.b>255-e?t.b=255:t.b<e&&(t.b=0),t})}),u.register("channels",function(e){var t;if("object"!=typeof e)return this;for(t in e)F.call(e,t)&&(0!==e[t]?e[t]/=100:delete e[t]);return 0===e.length?this:this.process("channels",function(t){return null!=e.red&&(0<e.red?t.r+=(255-t.r)*e.red:t.r-=t.r*Math.abs(e.red)),null!=e.green&&(0<e.green?t.g+=(255-t.g)*e.green:t.g-=t.g*Math.abs(e.green)),null!=e.blue&&(0<e.blue?t.b+=(255-t.b)*e.blue:t.b-=t.b*Math.abs(e.blue)),t})}),u.register("curves",function(){var t,r,n,e,i,s,o,a,h,c,u,l;if(n=arguments[0],"function"==typeof(o=(e=2<=arguments.length?L.call(arguments,1):[])[e.length-1])?(t=o,e.pop()):"string"==typeof o?(t=g[o],e.pop()):t=g.bezier,"string"==typeof n&&(n=n.split("")),"v"===n[0]&&(n=["r","g","b"]),e.length<2)throw"Invalid number of arguments to curves filter";if(r=t(e,0,255),0<(u=e[0])[0])for(s=a=0,h=u[0];0<=h?a<h:h<a;s=0<=h?++a:--a)r[s]=u[1];if((i=e[e.length-1])[0]<255)for(s=l=c=i[0];c<=255?l<=255:255<=l;s=c<=255?++l:--l)r[s]=i[1];return this.process("curves",function(t){var e,i;for(s=i=0,e=n.length;0<=e?i<e:e<i;s=0<=e?++i:--i)t[n[s]]=r[t[n[s]]];return t})}),u.register("exposure",function(t){var e,i,r;return e=[0,255*(r=Math.abs(t)/100)],i=[255-255*r,255],t<0&&(e=e.reverse(),i=i.reverse()),this.curves("rgb",[0,0],e,i,[255,255])}),I.Plugin.register("crop",function(t,e,i,r){var n;return null==i&&(i=0),null==r&&(r=0),"undefined"!=typeof exports&&null!==exports?n=new p(t,e):(n=document.createElement("canvas"),C.copyAttributes(this.canvas,n),n.width=t,n.height=e),n.getContext("2d").drawImage(this.canvas,i,r,t,e,0,0,t,e),this.cropCoordinates={x:i,y:r},this.cropped=!0,this.replaceCanvas(n)}),I.Plugin.register("resize",function(t){var e;if(null==t&&(t=null),null!==t&&(null!=t.width||null!=t.height))return null==t.width?t.width=this.canvas.width*t.height/this.canvas.height:null==t.height&&(t.height=this.canvas.height*t.width/this.canvas.width),"undefined"!=typeof exports&&null!==exports?e=new p(t.width,t.height):(e=document.createElement("canvas"),C.copyAttributes(this.canvas,e),e.width=t.width,e.height=t.height),e.getContext("2d").drawImage(this.canvas,0,0,this.canvas.width,this.canvas.height,0,0,t.width,t.height),this.resized=!0,this.replaceCanvas(e);S.error("Invalid or missing dimensions given for resize")}),I.Filter.register("crop",function(){return this.processPlugin("crop",Array.prototype.slice.call(arguments,0))}),I.Filter.register("resize",function(){return this.processPlugin("resize",Array.prototype.slice.call(arguments,0))}),I.Filter.register("boxBlur",function(){return this.processKernel("Box Blur",[1,1,1,1,1,1,1,1,1])}),I.Filter.register("heavyRadialBlur",function(){return this.processKernel("Heavy Radial Blur",[0,0,1,0,0,0,1,1,1,0,1,1,1,1,1,0,1,1,1,0,0,0,1,0,0])}),I.Filter.register("gaussianBlur",function(){return this.processKernel("Gaussian Blur",[1,4,6,4,1,4,16,24,16,4,6,24,36,24,6,4,16,24,16,4,1,4,6,4,1])}),I.Filter.register("motionBlur",function(t){var e;return e=0===t||180===t?[0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0]:0<t&&t<90||180<t&&t<270?[0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0]:90===t||270===t?[0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0]:[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1],this.processKernel("Motion Blur",e)}),I.Filter.register("sharpen",function(t){return null==t&&(t=100),t/=100,this.processKernel("Sharpen",[0,-t,0,-t,4*t+1,-t,0,-t,0])}),w={brightness:function(t,e,i){return t.r=t.r-t.r*e*i.strength,t.g=t.g-t.g*e*i.strength,t.b=t.b-t.b*e*i.strength,t},gamma:function(t,e,i){return t.r=255*Math.pow(t.r/255,Math.max(10*e*i.strength,1)),t.g=255*Math.pow(t.g/255,Math.max(10*e*i.strength,1)),t.b=255*Math.pow(t.b/255,Math.max(10*e*i.strength,1)),t},colorize:function(t,e,i){return t.r-=(t.r-i.color.r)*e,t.g-=(t.g-i.color.g)*e,t.b-=(t.b-i.color.b)*e,t}},u.register("vignette",function(n,s){var o,a,h,t;return null==s&&(s=60),"string"==typeof n&&"%"===n.substr(-1)&&(n=this.dimensions.height>this.dimensions.width?this.dimensions.width*(parseInt(n.substr(0,n.length-1),10)/100):this.dimensions.height*(parseInt(n.substr(0,n.length-1),10)/100)),s/=100,a=[this.dimensions.width/2,this.dimensions.height/2],t=Math.sqrt(Math.pow(a[0],2)+Math.pow(a[1],2)),h=t-n,o=g.bezier([0,1],[30,30],[70,60],[100,80]),this.process("vignette",function(t){var e,i,r;return r=t.locationXY(),e=g.distance(r.x,r.y,a[0],a[1]),h<e&&(i=Math.max(1,o[Math.round((e-h)/n*100)]/10*s),t.r=255*Math.pow(t.r/255,i),t.g=255*Math.pow(t.g/255,i),t.b=255*Math.pow(t.b/255,i)),t})}),u.register("rectangularVignette",function(r){var t,e,i,n,s,o,a;if(t={strength:50,cornerRadius:0,method:"brightness",color:{r:0,g:0,b:0}},!(r=C.extend(t,r)).size)return this;if("string"==typeof r.size)s=parseInt(r.size,10)/100,r.size={width:this.dimensions.width*s,height:this.dimensions.height*s};else if("object"==typeof r.size)for(n=0,i=(o=["width","height"]).length;n<i;n++)e=o[n],"string"==typeof r.size[e]&&(r.size[e]=this.dimensions[e]*(parseInt(r.size[e],10)/100));else"number"===r.size&&(a=r.size,r.size={width:a,height:a});return"string"==typeof r.cornerRadius&&(r.cornerRadius=r.size.width/2*(parseInt(r.cornerRadius,10)/100)),r.strength/=100,r.size.width=Math.floor(r.size.width),r.size.height=Math.floor(r.size.height),r.image={width:this.dimensions.width,height:this.dimensions.height},"colorize"===r.method&&"string"==typeof r.color&&(r.color=h.hexToRGB(r.color)),r.coords={left:(this.dimensions.width-r.size.width)/2,right:this.dimensions.width-r.coords.left,bottom:(this.dimensions.height-r.size.height)/2,top:this.dimensions.height-r.coords.bottom},r.corners=[{x:r.coords.left+r.cornerRadius,y:r.coords.top-r.cornerRadius},{x:r.coords.right-r.cornerRadius,y:r.coords.top-r.cornerRadius},{x:r.coords.right-r.cornerRadius,y:r.coords.bottom+r.cornerRadius},{x:r.coords.left+r.cornerRadius,y:r.coords.bottom+r.cornerRadius}],r.maxDist=g.distance(0,0,r.corners[3].x,r.corners[3].y)-r.cornerRadius,this.process("rectangularVignette",function(t){var e,i;return(i=t.locationXY()).x>r.corners[0].x&&i.x<r.corners[1].x&&i.y>r.coords.bottom&&i.y<r.coords.top?t:i.x>r.coords.left&&i.x<r.coords.right&&i.y>r.corners[3].y&&i.y<r.corners[2].y?t:(i.x>r.corners[0].x&&i.x<r.corners[1].x&&i.y>r.coords.top?e=(i.y-r.coords.top)/r.maxDist:i.y>r.corners[2].y&&i.y<r.corners[1].y&&i.x>r.coords.right?e=(i.x-r.coords.right)/r.maxDist:i.x>r.corners[0].x&&i.x<r.corners[1].x&&i.y<r.coords.bottom?e=(r.coords.bottom-i.y)/r.maxDist:i.y>r.corners[2].y&&i.y<r.corners[1].y&&i.x<r.coords.left?e=(r.coords.left-i.x)/r.maxDist:i.x<=r.corners[0].x&&i.y>=r.corners[0].y?e=(I.distance(i.x,i.y,r.corners[0].x,r.corners[0].y)-r.cornerRadius)/r.maxDist:i.x>=r.corners[1].x&&i.y>=r.corners[1].y?e=(I.distance(i.x,i.y,r.corners[1].x,r.corners[1].y)-r.cornerRadius)/r.maxDist:i.x>=r.corners[2].x&&i.y<=r.corners[2].y?e=(I.distance(i.x,i.y,r.corners[2].x,r.corners[2].y)-r.cornerRadius)/r.maxDist:i.x<=r.corners[3].x&&i.y<=r.corners[3].y&&(e=(I.distance(i.x,i.y,r.corners[3].x,r.corners[3].y)-r.cornerRadius)/r.maxDist),e<0?t:w[r.method](t,e,r))})}),yt=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259],bt=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24],D=function(t,e,i,r,n,s,o){var a,h,c,u,l,g,d;return(a="undefined"!=typeof exports&&null!==exports?new p:document.createElement("canvas")).width=t,a.height=e,u=i+Math.cos(n)*s*.5,g=r+Math.sin(n)*s*.5,l=i-Math.cos(n)*s*.5,d=r-Math.sin(n)*s*.5,c=(h=a.getContext("2d")).createLinearGradient(u,g,l,d),o?(c.addColorStop(0,"white"),c.addColorStop(.5,"black"),c.addColorStop(1,"white")):(c.addColorStop(0,"white"),c.addColorStop(1,"black")),h.fillStyle=c,h.fillRect(0,0,t,e),h.getImageData(0,0,t,e)},R=function(t,e,i,r,n,s){var o,a,h;return(o="undefined"!=typeof exports&&null!==exports?new p:document.createElement("canvas")).width=t,o.height=e,(h=(a=o.getContext("2d")).createRadialGradient(i,r,n,i,r,s)).addColorStop(1,"white"),h.addColorStop(0,"black"),a.fillStyle=h,a.fillRect(0,0,t,e),a.getImageData(0,0,t,e)},mt=function(){return this.r=0,this.g=0,this.b=0,this.a=0,this.next=null},I.Plugin.register("compoundBlur",function(t,e,i,r){var n,s,o,a,h,c,u,l,g,d,p,f,m,y,b,x,v,w,D,R,M,P,S,I,B,C,L,F,k,z,T,A,J,N,j,O,H,E,G,W,q,U,K,V,Q,X,Y,_,Z,$,tt,et,it,rt,nt,st,ot,at,ht,ct,ut,lt,gt,dt,pt,ft;for(ct=this.dimensions.width,d=this.dimensions.height,x=this.pixelData,O=t.data,z=[],f=B=0,G=(ht=ct*d)<<2;0<=G?B<G:G<B;f=0<=G?++B:--B)z[f]=x[f];for(h=0,nt=r,r-=1;0<=nt--;)if(0!=(w=e+.5|0)){for(256<w&&(w=256),c=w+w+1,ut=ct-1,p=d-1,st=(H=w+1)*(H+1)/2,tt=void 0,$=rt=new mt,f=ot=1,W=c;1<=W?ot<W:W<ot;f=1<=W?++ot:--ot)$=$.next=new mt,f===H&&(tt=$);for($.next=rt,it=et=null,ft=dt=0,S=yt[w],Z=bt[w],gt=at=0,q=d;0<=q?at<q:q<at;gt=0<=q?++at:--at){for(J=u=n=j=g=o=0,N=H*(T=z[dt]),l=H*(k=z[dt+1]),s=H*(F=z[dt+2]),j+=st*T,g+=st*k,o+=st*F,$=rt,f=m=0,U=H;0<=U?m<U:U<m;f=0<=U?++m:--m)$.r=T,$.g=k,$.b=F,$=$.next;for(f=D=1,K=H;1<=K?D<K:K<D;f=1<=K?++D:--D)L=dt+((ut<f?ut:f)<<2),j+=($.r=T=z[L])*(E=H-f),g+=($.g=k=z[L+1])*E,o+=($.b=F=z[L+2])*E,J+=T,u+=k,n+=F,$=$.next;for(et=rt,it=tt,lt=R=0,V=ct;0<=V?R<V:V<R;lt=0<=V?++R:--R)z[dt]=j*S>>Z,z[dt+1]=g*S>>Z,z[dt+2]=o*S>>Z,j-=N,g-=l,o-=s,N-=et.r,l-=et.g,s-=et.b,L=ft+((L=lt+H)<ut?L:ut)<<2,j+=J+=et.r=z[L],g+=u+=et.g=z[L+1],o+=n+=et.b=z[L+2],et=et.next,N+=T=it.r,l+=k=it.g,s+=F=it.b,J-=T,u-=k,n-=F,it=it.next,dt+=4;ft+=ct}for(lt=M=0,Q=ct;0<=Q?M<Q:Q<M;lt=0<=Q?++M:--M){for(u=n=J=g=o=j=0,N=H*(T=z[dt=lt<<2]),l=H*(k=z[dt+1]),s=H*(F=z[dt+2]),j+=st*T,g+=st*k,o+=st*F,$=rt,f=I=0,X=H;0<=X?I<X:X<I;f=0<=X?++I:--I)$.r=T,$.g=k,$.b=F,$=$.next;for(pt=ct,f=C=1,Y=H;1<=Y?C<Y:Y<C;f=1<=Y?++C:--C)dt=pt+lt<<2,j+=($.r=T=z[dt])*(E=H-f),g+=($.g=k=z[dt+1])*E,o+=($.b=F=z[dt+2])*E,J+=T,u+=k,n+=F,$=$.next,f<p&&(pt+=ct);for(dt=lt,et=rt,it=tt,gt=A=0,_=d;0<=_?A<_:_<A;gt=0<=_?++A:--A)z[L=dt<<2]=j*S>>Z,z[L+1]=g*S>>Z,z[L+2]=o*S>>Z,j-=N,g-=l,o-=s,N-=et.r,l-=et.g,s-=et.b,L=lt+((L=gt+H)<p?L:p)*ct<<2,j+=J+=et.r=z[L],g+=u+=et.g=z[L+1],o+=n+=et.b=z[L+2],et=et.next,N+=T=it.r,l+=k=it.g,s+=F=it.b,J-=T,u-=k,n-=F,it=it.next,dt+=ct}for(e*=i,f=ht;-1<--f;)(v=0|(P=(255&O[2+(b=f<<2)])/255*r))===h?(y=256-(a=256*(P-(0|P))),x[b]=x[b]*y+z[b]*a>>8,x[b+1]=x[b+1]*y+z[b+1]*a>>8,x[b+2]=x[b+2]*y+z[b+2]*a>>8):v===h+1&&(x[b]=z[b],x[b+1]=z[b+1],x[b+2]=z[b+2]);h++}return this}),I.Filter.register("tiltShift",function(t){var e,i;return e={center:{x:this.dimensions.width/2,y:this.dimensions.height/2},angle:45,focusWidth:200,startRadius:3,radiusFactor:1.5,steps:3},(t=C.extend(e,t)).angle*=Math.PI/180,i=D(this.dimensions.width,this.dimensions.height,t.center.x,t.center.y,t.angle,t.focusWidth,!0),this.processPlugin("compoundBlur",[i,t.startRadius,t.radiusFactor,t.steps])}),I.Filter.register("radialBlur",function(t){var e,i,r,n;return e={size:50,center:{x:this.dimensions.width/2,y:this.dimensions.height/2},startRadius:3,radiusFactor:1.5,steps:3,radius:null},(t=C.extend(e,t)).radius||(t.radius=this.dimensions.width<this.dimensions.height?this.dimensions.height:this.dimensions.width),r=t.radius/2-t.size,n=t.radius/2,i=R(this.dimensions.width,this.dimensions.height,t.center.x,t.center.y,r,n),this.processPlugin("compoundBlur",[i,t.startRadius,t.radiusFactor,t.steps])}),I.Filter.register("edgeEnhance",function(){return this.processKernel("Edge Enhance",[0,0,0,-1,1,0,0,0,0])}),I.Filter.register("edgeDetect",function(){return this.processKernel("Edge Detect",[-1,-1,-1,-1,8,-1,-1,-1,-1])}),I.Filter.register("emboss",function(){return this.processKernel("Emboss",[-2,-1,0,-1,1,1,0,1,2])}),I.Filter.register("posterize",function(t){var e,i;return e=256/t,i=255/(t-1),this.process("posterize",function(t){return t.r=Math.floor(Math.floor(t.r/e)*i),t.g=Math.floor(Math.floor(t.g/e)*i),t.b=Math.floor(Math.floor(t.b/e)*i),t})}),I.Filter.register("vintage",function(t){if(null==t&&(t=!0),this.greyscale(),this.contrast(5),this.noise(3),this.sepia(100),this.channels({red:8,blue:2,green:4}),this.gamma(.87),t)return this.vignette("40%",30)}),I.Filter.register("lomo",function(t){return null==t&&(t=!0),this.brightness(15),this.exposure(15),this.curves("rgb",[0,0],[200,0],[155,255],[255,255]),this.saturation(-20),this.gamma(1.8),t&&this.vignette("50%",60),this.brightness(5)}),I.Filter.register("clarity",function(t){return null==t&&(t=!1),this.vibrance(20),this.curves("rgb",[5,0],[130,150],[190,220],[250,255]),this.sharpen(15),this.vignette("45%",20),t&&(this.greyscale(),this.contrast(4)),this}),I.Filter.register("sinCity",function(){return this.contrast(100),this.brightness(15),this.exposure(10),this.posterize(80),this.clip(30),this.greyscale()}),I.Filter.register("sunrise",function(){return this.exposure(3.5),this.saturation(-5),this.vibrance(50),this.sepia(60),this.colorize("#e87b22",10),this.channels({red:8,blue:8}),this.contrast(5),this.gamma(1.2),this.vignette("55%",25)}),I.Filter.register("crossProcess",function(){return this.exposure(5),this.colorize("#e87b22",4),this.sepia(20),this.channels({blue:8,red:3}),this.curves("b",[0,0],[100,150],[180,180],[255,255]),this.contrast(15),this.vibrance(75),this.gamma(1.6)}),I.Filter.register("orangePeel",function(){return this.curves("rgb",[0,0],[100,50],[140,200],[255,255]),this.vibrance(-30),this.saturation(-30),this.colorize("#ff9000",30),this.contrast(-5),this.gamma(1.4)}),I.Filter.register("love",function(){return this.brightness(5),this.exposure(8),this.contrast(4),this.colorize("#c42007",30),this.vibrance(50),this.gamma(1.3)}),I.Filter.register("grungy",function(){return this.gamma(1.5),this.clip(25),this.saturation(-60),this.contrast(5),this.noise(5),this.vignette("50%",30)}),I.Filter.register("jarques",function(){return this.saturation(-35),this.curves("b",[20,0],[90,120],[186,144],[255,230]),this.curves("r",[0,0],[144,90],[138,120],[255,255]),this.curves("g",[10,0],[115,105],[148,100],[255,248]),this.curves("rgb",[0,0],[120,100],[128,140],[255,255]),this.sharpen(20)}),I.Filter.register("pinhole",function(){return this.greyscale(),this.sepia(10),this.exposure(10),this.contrast(15),this.vignette("60%",35)}),I.Filter.register("oldBoot",function(){return this.saturation(-20),this.vibrance(-50),this.gamma(1.1),this.sepia(30),this.channels({red:-10,blue:5}),this.curves("rgb",[0,0],[80,50],[128,230],[255,255]),this.vignette("60%",30)}),I.Filter.register("glowingSun",function(t){if(null==t&&(t=!0),this.brightness(10),this.newLayer(function(){return this.setBlendingMode("multiply"),this.opacity(80),this.copyParent(),this.filter.gamma(.8),this.filter.contrast(50),this.filter.exposure(10)}),this.newLayer(function(){return this.setBlendingMode("softLight"),this.opacity(80),this.fillColor("#f49600")}),this.exposure(20),this.gamma(.8),t)return this.vignette("45%",20)}),I.Filter.register("hazyDays",function(){return this.gamma(1.2),this.newLayer(function(){return this.setBlendingMode("overlay"),this.opacity(60),this.copyParent(),this.filter.channels({red:5}),this.filter.stackBlur(15)}),this.newLayer(function(){return this.setBlendingMode("addition"),this.opacity(40),this.fillColor("#6899ba")}),this.newLayer(function(){return this.setBlendingMode("multiply"),this.opacity(35),this.copyParent(),this.filter.brightness(40),this.filter.vibrance(40),this.filter.exposure(30),this.filter.contrast(15),this.filter.curves("r",[0,40],[128,128],[128,128],[255,215]),this.filter.curves("g",[0,40],[128,128],[128,128],[255,215]),this.filter.curves("b",[0,40],[128,128],[128,128],[255,215]),this.filter.stackBlur(5)}),this.curves("r",[20,0],[128,158],[128,128],[235,255]),this.curves("g",[20,0],[128,128],[128,128],[235,255]),this.curves("b",[20,0],[128,108],[128,128],[235,255]),this.vignette("45%",20)}),I.Filter.register("herMajesty",function(){return this.brightness(40),this.colorize("#ea1c5d",10),this.curves("b",[0,10],[128,180],[190,190],[255,255]),this.newLayer(function(){return this.setBlendingMode("overlay"),this.opacity(50),this.copyParent(),this.filter.gamma(.7),this.newLayer(function(){return this.setBlendingMode("normal"),this.opacity(60),this.fillColor("#ea1c5d")})}),this.newLayer(function(){return this.setBlendingMode("multiply"),this.opacity(60),this.copyParent(),this.filter.saturation(50),this.filter.hue(90),this.filter.contrast(10)}),this.gamma(1.4),this.vibrance(-30),this.newLayer(function(){return this.opacity(10),this.fillColor("#e5f0ff")}),this}),I.Filter.register("nostalgia",function(){return this.saturation(20),this.gamma(1.4),this.greyscale(),this.contrast(5),this.sepia(100),this.channels({red:8,blue:2,green:4}),this.gamma(.8),this.contrast(5),this.exposure(10),this.newLayer(function(){return this.setBlendingMode("overlay"),this.copyParent(),this.opacity(55),this.filter.stackBlur(10)}),this.vignette("50%",30)}),I.Filter.register("hemingway",function(){return this.greyscale(),this.contrast(10),this.gamma(.9),this.newLayer(function(){return this.setBlendingMode("multiply"),this.opacity(40),this.copyParent(),this.filter.exposure(15),this.filter.contrast(15),this.filter.channels({green:10,red:5})}),this.sepia(30),this.curves("rgb",[0,10],[120,90],[180,200],[235,255]),this.channels({red:5,green:-2}),this.exposure(15)}),I.Filter.register("concentrate",function(){return this.sharpen(40),this.saturation(-50),this.channels({red:3}),this.newLayer(function(){return this.setBlendingMode("multiply"),this.opacity(80),this.copyParent(),this.filter.sharpen(5),this.filter.contrast(50),this.filter.exposure(10),this.filter.channels({blue:5})}),this.brightness(10)}),I.Plugin.register("rotate",function(t){var e,i,r,n,s,o,a,h;return 0===(e=t%360)?this.dimensions={width:this.canvas.width,height:this.canvas.height}:(s=Math.PI/180,"undefined"!=typeof exports&&null!==exports?i=new p:(i=document.createElement("canvas"),C.copyAttributes(this.canvas,i)),90===e||-270===e||270===e||-90===e?(a=(o=this.canvas.height)/2,h=(n=this.canvas.width)/2):180===e?(a=(o=this.canvas.width)/2,h=(n=this.canvas.height)/2):(n=o=Math.sqrt(Math.pow(this.originalWidth,2)+Math.pow(this.originalHeight,2)),a=this.canvas.height/2,h=this.canvas.width/2),i.width=o,i.height=n,(r=i.getContext("2d")).save(),r.translate(a,h),r.rotate(e*s),r.drawImage(this.canvas,-this.canvas.width/2,-this.canvas.height/2,this.canvas.width,this.canvas.height),r.restore(),this.replaceCanvas(i))}),I.Filter.register("rotate",function(){return this.processPlugin("rotate",Array.prototype.slice.call(arguments,0))}),et=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259],it=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24],tt=function(){return this.r=0,this.g=0,this.b=0,this.a=0,this.next=null},I.Plugin.register("stackBlur",function(t){var e,i,r,n,s,o,a,h,c,u,l,g,d,p,f,m,y,b,x,v,w,D,R,M,P,S,I,B,C,L,F,k,z,T,A,J,N,j,O,H,E,G,W,q,U,K,V,Q,X,Y,_,Z,$;if(!(isNaN(t)||t<1)){for(t|=0,D=this.pixelData,n=t+t+1,V=this.dimensions.width,Q=V-1,c=(h=this.dimensions.height)-1,q=(I=t+1)*(I+1)/2,O=W=new tt,u=y=1,C=n;1<=C?y<C:C<y;u=1<=C?++y:--y)O=O.next=new tt,u===I&&(H=O);for(O.next=W,G=E=null,$=_=0,f=et[t],j=it[t],Y=U=0,L=h;0<=L?U<L:L<U;Y=0<=L?++U:--U){for(M=s=e=S=a=r=0,P=I*(R=D[_]),o=I*(w=D[_+1]),i=I*(v=D[_+2]),S+=q*R,a+=q*w,r+=q*v,O=W,u=K=0,F=I;0<=F?K<F:F<K;u=0<=F?++K:--K)O.r=R,O.g=w,O.b=v,O=O.next;for(u=l=1,k=I;1<=k?l<k:k<l;u=1<=k?++l:--l)x=_+((Q<u?Q:u)<<2),S+=(O.r=R=D[x])*(B=I-u),a+=(O.g=w=D[x+1])*B,r+=(O.b=v=D[x+2])*B,M+=R,s+=w,e+=v,O=O.next;for(E=W,G=H,X=g=0,z=V;0<=z?g<z:z<g;X=0<=z?++g:--g)D[_]=S*f>>j,D[_+1]=a*f>>j,D[_+2]=r*f>>j,S-=P,a-=o,r-=i,P-=E.r,o-=E.g,i-=E.b,x=$+((x=X+t+1)<Q?x:Q)<<2,S+=M+=E.r=D[x],a+=s+=E.g=D[x+1],r+=e+=E.b=D[x+2],E=E.next,P+=R=G.r,o+=w=G.g,i+=v=G.b,M-=R,s-=w,e-=v,G=G.next,_+=4;$+=V}for(X=d=0,T=V;0<=T?d<T:T<d;X=0<=T?++d:--d){for(s=e=M=a=r=S=0,P=I*(R=D[_=X<<2]),o=I*(w=D[_+1]),i=I*(v=D[_+2]),S+=q*R,a+=q*w,r+=q*v,O=W,u=p=0,A=I;0<=A?p<A:A<p;u=0<=A?++p:--p)O.r=R,O.g=w,O.b=v,O=O.next;for(Z=V,u=m=1,J=t;1<=J?m<=J:J<=m;u=1<=J?++m:--m)_=Z+X<<2,S+=(O.r=R=D[_])*(B=I-u),a+=(O.g=w=D[_+1])*B,r+=(O.b=v=D[_+2])*B,M+=R,s+=w,e+=v,O=O.next,u<c&&(Z+=V);for(_=X,E=W,G=H,Y=b=0,N=h;0<=N?b<N:N<b;Y=0<=N?++b:--b)D[x=_<<2]=S*f>>j,D[x+1]=a*f>>j,D[x+2]=r*f>>j,S-=P,a-=o,r-=i,P-=E.r,o-=E.g,i-=E.b,x=X+((x=Y+I)<c?x:c)*V<<2,S+=M+=E.r=D[x],a+=s+=E.g=D[x+1],r+=e+=E.b=D[x+2],E=E.next,P+=R=G.r,o+=w=G.g,i+=v=G.b,M-=R,s-=w,e-=v,G=G.next,_+=V}return this}}),I.Filter.register("stackBlur",function(t){return this.processPlugin("stackBlur",[t])}),I.Filter.register("threshold",function(e){return this.process("threshold",function(t){return.2126*t.r+.7152*t.g+.0722*t.b<e?(t.r=0,t.g=0,t.b=0):(t.r=255,t.g=255,t.b=255),t})})}).call(this);